# netapp_cloudmanager_connector_aws

> This project was generated by [generator-tf-module](https://github.com/sudokar/generator-tf-module)

## Overview

A module to create a NetApp Cloud Manager Connector instance in AWS. It will create all the required resources including iam_instance_profile, security group and security group rules.

To make use of this module there are a number of external pre-requistes that must be provided:

- *NetApp Cloud Manager account*: You need to create a Cloud Manager account that the NetApp Connector can join to https://cloud.netapp.com/cloud-manager
- *NetApp Refresh token*: This is available once you have created the NetApp account and logged in, the following URL should link to your refresh token https://services.cloud.netapp.com/refresh-token
- *NetApp Account Id*: Available from the Cloud Manager Portal once logged in, navigate to https://cloudmanager.netapp.com/working-environments  and select **Account** and **Manage Account**.
- *AWS NetApp Subscription*: Before you can deploy to AWS you must first accept the subscription T&Cs for the NetApp connector in the AWS Marketplace: https://aws.amazon.com/marketplace/pp/B07QX2QLXX?ref_=beagle&applicationId=AWS-Marketplace-Console


## Usage

You must have the prequisties completed and ready to supply before you can run the below example code.

```hcl
terraform {
  required_version = ">= 0.13.0, < 0.14"

  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = ">= 0.3, < 4.0"
    }
    netapp-cloudmanager = {
      source  = "NetApp/netapp-cloudmanager"
      version = "20.12"
    }
  }
}

provider "aws" {}

provider "netapp-cloudmanager" {
  refresh_token = var.cloudmanager_refresh_token
}

module "vpc" {
  source  = "terraform-aws-modules/vpc/aws"
  version = "2.57.0"

  name = "netapp"

  cidr = "10.10.0.0/16"

  azs             = ["eu-west-2a"]
  public_subnets  = ["10.10.10.0/24"]
  private_subnets = ["10.10.11.0/24"]

  enable_nat_gateway = true
  enable_vpn_gateway = false

  enable_dns_hostnames = true
  enable_dns_support   = true

  enable_ipv6 = false

  tags = {
    Owner       = "user"
    Environment = "dev"
  }

  vpc_tags = {
    Name = "vpc-name"
  }
}

data "aws_security_groups" "default" {
  filter {
    name   = "vpc-id"
    values = [module.vpc.vpc_id]
  }
}

module "netapp_connector" {
  source = "git@github.com:companieshouse/terraform-modules//aws/netapp_cloudmanager_connector_aws"

  name              = var.cloudmanager_name
  vpc_id            = module.vpc.vpc_id
  region            = var.region
  company_name      = "module-test-co"
  instance_type     = "t3.xlarge"
  key_pair_name     = var.key_pair_name
  subnet_id         = coalesce(module.vpc.private_subnets...)
  set_public_ip     = false
  netapp_account_id = var.cloudmanager_account_id

  ingress_ports = [
    { "protocol" = "tcp", "port" = 22 },
    { "protocol" = "tcp", "port" = 80 },
    { "protocol" = "tcp", "port" = 443 },
  ]

  egress_ports = [
    { "protocol" = "-1", "port" = 0 },
  ]

  ingress_cidr_blocks = [
    "10.10.1.0/24",
  ]

  egress_cidr_blocks = [
    "0.0.0.0/0"
  ]

  tags = {
    Terraform = "true",
  }
}
```

<!-- BEGINNING OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 0.13.0, < 0.14 |
| <a name="requirement_aws"></a> [aws](#requirement\_aws) | >= 0.3, < 4.0 |
| <a name="requirement_netapp-cloudmanager"></a> [netapp-cloudmanager](#requirement\_netapp-cloudmanager) | >= 20.12 |

## Providers

| Name | Version |
|------|---------|
| <a name="provider_aws"></a> [aws](#provider\_aws) | >= 0.3, < 4.0 |
| <a name="provider_netapp-cloudmanager"></a> [netapp-cloudmanager](#provider\_netapp-cloudmanager) | >= 20.12 |

## Modules

No modules.

## Resources

| Name | Type |
|------|------|
| [aws_iam_instance_profile.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_instance_profile) | resource |
| [aws_iam_policy.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_policy) | resource |
| [aws_iam_role.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role) | resource |
| [aws_iam_role_policy_attachment.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role_policy_attachment) | resource |
| [aws_security_group.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group) | resource |
| [aws_security_group_rule.egress_cidrs](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group_rule) | resource |
| [aws_security_group_rule.egress_sgs](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group_rule) | resource |
| [aws_security_group_rule.ingress_cidrs](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group_rule) | resource |
| [aws_security_group_rule.ingress_sgs](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group_rule) | resource |
| [aws_security_group_rule.internal](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group_rule) | resource |
| [netapp-cloudmanager_connector_aws.this](https://registry.terraform.io/providers/NetApp/netapp-cloudmanager/latest/docs/resources/connector_aws) | resource |
| [aws_caller_identity.current](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/caller_identity) | data source |
| [aws_iam_policy_document.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document) | data source |
| [aws_region.current](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/region) | data source |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_build_connector"></a> [build\_connector](#input\_build\_connector) | Control whether we build the NetApp connector component or not | `bool` | `true` | no |
| <a name="input_company_name"></a> [company\_name](#input\_company\_name) | The Company name for deployment, to be used in creating resources for NetApp | `string` | n/a | yes |
| <a name="input_egress_cidr_blocks"></a> [egress\_cidr\_blocks](#input\_egress\_cidr\_blocks) | List of CIDR blocks to allow egress traffic from NetApp Connector. | `list(string)` | <pre>[<br>  "0.0.0.0/0"<br>]</pre> | no |
| <a name="input_egress_ports"></a> [egress\_ports](#input\_egress\_ports) | A list of egress port maps that requires protocol and port to be defined and allows to\_port as optional | `any` | <pre>[<br>  {<br>    "port": 0,<br>    "protocol": "icmp",<br>    "to_port": 0<br>  },<br>  {<br>    "port": 0,<br>    "protocol": "tcp",<br>    "to_port": 0<br>  },<br>  {<br>    "port": 0,<br>    "protocol": "udp",<br>    "to_port": 0<br>  }<br>]</pre> | no |
| <a name="input_egress_security_group_ids"></a> [egress\_security\_group\_ids](#input\_egress\_security\_group\_ids) | List of security groups to allow egress traffic from NetApp Connector. | `list(string)` | `[]` | no |
| <a name="input_ingress_cidr_blocks"></a> [ingress\_cidr\_blocks](#input\_ingress\_cidr\_blocks) | List of CIDR blocks to allow ingress traffic to NetApp Connector. | `list(string)` | `[]` | no |
| <a name="input_ingress_ports"></a> [ingress\_ports](#input\_ingress\_ports) | A list of ingress port maps that requires protocol and port to be defined and allows to\_port as optional | `any` | <pre>[<br>  {<br>    "port": 80,<br>    "protocol": "tcp"<br>  },<br>  {<br>    "port": 443,<br>    "protocol": "tcp"<br>  },<br>  {<br>    "port": 22,<br>    "protocol": "tcp"<br>  }<br>]</pre> | no |
| <a name="input_ingress_security_group_ids"></a> [ingress\_security\_group\_ids](#input\_ingress\_security\_group\_ids) | List of security groups to allow ingress traffic to NetApp Connector. | `list(string)` | `[]` | no |
| <a name="input_instance_type"></a> [instance\_type](#input\_instance\_type) | The instance\_type that the Connector will be deployed as | `string` | n/a | yes |
| <a name="input_key_pair_name"></a> [key\_pair\_name](#input\_key\_pair\_name) | Name of the key pair to be used when creating the connector instance | `string` | `null` | no |
| <a name="input_name"></a> [name](#input\_name) | A name to be added to each of the resources created by this module | `string` | `"netapp-connector"` | no |
| <a name="input_netapp_account_id"></a> [netapp\_account\_id](#input\_netapp\_account\_id) | The Id of the NetApp Cloud Manager account being used | `string` | `null` | no |
| <a name="input_netapp_cvo_accountIds"></a> [netapp\_cvo\_accountIds](#input\_netapp\_cvo\_accountIds) | AWS account IDs for each CVO account if deployed in multiple AWS accounts, leave null if in the same account | `list(string)` | `null` | no |
| <a name="input_set_public_ip"></a> [set\_public\_ip](#input\_set\_public\_ip) | True/False boolean for setting a public IP on the Connector instance | `bool` | `false` | no |
| <a name="input_subnet_id"></a> [subnet\_id](#input\_subnet\_id) | The subnet\_id that the Connector instance will be deployed into | `string` | n/a | yes |
| <a name="input_tags"></a> [tags](#input\_tags) | A map of tags to add to all resources | `map(string)` | <pre>{<br>  "Terraform": "True"<br>}</pre> | no |
| <a name="input_vpc_id"></a> [vpc\_id](#input\_vpc\_id) | The Id of the VPC that this module will deploy into | `string` | n/a | yes |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_occm_account_id"></a> [occm\_account\_id](#output\_occm\_account\_id) | Account ID of the Cloudmanager Connector |
| <a name="output_occm_client_id"></a> [occm\_client\_id](#output\_occm\_client\_id) | Client ID of the Cloudmanager Connector |
| <a name="output_occm_id"></a> [occm\_id](#output\_occm\_id) | ID of the Cloudmanager Connector |
| <a name="output_occm_instance_profile_arn"></a> [occm\_instance\_profile\_arn](#output\_occm\_instance\_profile\_arn) | ARN of the instance profile created for Cloudmanager Connector |
| <a name="output_occm_instance_profile_name"></a> [occm\_instance\_profile\_name](#output\_occm\_instance\_profile\_name) | Name of the instance profile created for Cloudmanager Connector |
| <a name="output_occm_instance_profile_unique_id"></a> [occm\_instance\_profile\_unique\_id](#output\_occm\_instance\_profile\_unique\_id) | Unique identifier of the instance profile created for Cloudmanager Connector |
| <a name="output_occm_role_unique_id"></a> [occm\_role\_unique\_id](#output\_occm\_role\_unique\_id) | Unique identifier of the role created for Cloudmanager Connector |
| <a name="output_occm_security_group_id"></a> [occm\_security\_group\_id](#output\_occm\_security\_group\_id) | ID of the security group Cloudmanager Connector is a member of |
<!-- END OF PRE-COMMIT-TERRAFORM DOCS HOOK -->

## Development

### Prerequisites

- [terraform](https://learn.hashicorp.com/terraform/getting-started/install#installing-terraform)
- [terraform-docs](https://github.com/segmentio/terraform-docs)
- [pre-commit](https://pre-commit.com/#install)
- [golang](https://golang.org/doc/install#install)
- [golint](https://github.com/golang/lint#installation)

### Configurations

- Configure pre-commit hooks
```sh
pre-commit install
```


- Configure golang deps for tests
```sh
> go get github.com/gruntwork-io/terratest/modules/terraform
> go get github.com/stretchr/testify/assert
```



### Tests

Tests are available in `test` directory, to make use of the test file you will need to create 2 environment variables for it to "collect":

```sh
  export OCCM_REFRESH_TOKEN=<your refresh token>
  export OCCM_ACCOUNT_ID=<your account Id>
```
Once setup you can run the tests as follows:

- In the test directory, run the below command
```sh
go test
```



## Authors

This project is authored by below people

- Martin Fox, Stuart Hunter

> This project was generated by [generator-tf-module](https://github.com/sudokar/generator-tf-module)
