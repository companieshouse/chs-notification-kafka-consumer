# netapp_cloudmanager_cvo_aws

> This project was generated by [generator-tf-module](https://github.com/sudokar/generator-tf-module)

## Overview

Creates a new Cloud Volume ONTAP system in AWS with all dependancies

## Usage

```hcl
module "cvo" {
  source = "git::ssh://git@github.com:companieshouse/terraform-modules.git//aws/netapp_cloudmanager_cvo_aws"

  name = var.name
  short_name = var.short_name

  cluster_floating_ips = var.cluster_floating_ips
  connector_client_id  = module.netapp_cloudmanager_connector_aws.client_id

  ingress_cidr_blocks        = [data.aws_vpc.default.cidr_block]
  ingress_security_group_ids = [aws_security_group.this.id]
  mediator_key_pair_name     = var.key_name
  subnet_ids                 = data.aws_subnet_ids.this.ids
  svm_password               = var.svm_password
  vpc_id                     = data.aws_vpc.default.id
  route_table_ids            = data.aws_route_table.this[*].route_table_id

  depends_on = [module.netapp_cloudmanager_connector_aws]
}
```

<!-- BEGINNING OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 0.13, < 0.14 |
| <a name="requirement_aws"></a> [aws](#requirement\_aws) | >= 3.0, < 4.0 |
| <a name="requirement_netapp-cloudmanager"></a> [netapp-cloudmanager](#requirement\_netapp-cloudmanager) | >= 20.12 |

## Providers

| Name | Version |
|------|---------|
| <a name="provider_aws"></a> [aws](#provider\_aws) | >= 3.0, < 4.0 |
| <a name="provider_netapp-cloudmanager"></a> [netapp-cloudmanager](#provider\_netapp-cloudmanager) | >= 20.12 |

## Modules

No modules.

## Resources

| Name | Type |
|------|------|
| [aws_iam_instance_profile.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_instance_profile) | resource |
| [aws_iam_policy.cvo](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_policy) | resource |
| [aws_iam_policy.cvo_ha_mediator](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_policy) | resource |
| [aws_iam_policy.this_connector](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_policy) | resource |
| [aws_iam_role.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role) | resource |
| [aws_iam_role.this_connector](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role) | resource |
| [aws_iam_role_policy_attachment.cvo](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role_policy_attachment) | resource |
| [aws_iam_role_policy_attachment.cvo_ha_mediator](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role_policy_attachment) | resource |
| [aws_iam_role_policy_attachment.this_connector](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role_policy_attachment) | resource |
| [aws_security_group.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group) | resource |
| [aws_security_group_rule.egress_ports](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group_rule) | resource |
| [aws_security_group_rule.ingress_cidrs](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group_rule) | resource |
| [aws_security_group_rule.ingress_sgs](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group_rule) | resource |
| [aws_security_group_rule.internal](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group_rule) | resource |
| [netapp-cloudmanager_cvo_aws.cvo_aws](https://registry.terraform.io/providers/NetApp/netapp-cloudmanager/latest/docs/resources/cvo_aws) | resource |
| [aws_caller_identity.current](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/caller_identity) | data source |
| [aws_iam_policy_document.cvo](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document) | data source |
| [aws_iam_policy_document.cvo_ha_mediator](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document) | data source |
| [aws_iam_policy_document.this_connector](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document) | data source |
| [aws_region.current](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/region) | data source |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_capacity_tier"></a> [capacity\_tier](#input\_capacity\_tier) | (Optional) Whether to enable data tiering for the first data aggregate: ['S3','NONE']. The default is 'S3'. | `string` | `"S3"` | no |
| <a name="input_cloud_provider_account"></a> [cloud\_provider\_account](#input\_cloud\_provider\_account) | (Optional) The cloud provider credentials id to use when deploying the Cloud Volumes ONTAP system. You can find the ID in Cloud Manager from the Settings > Credentials page. If not specified, Cloud Manager uses the instance profile of the Connector. | `string` | `null` | no |
| <a name="input_cluster_floating_ips"></a> [cluster\_floating\_ips](#input\_cluster\_floating\_ips) | List of Floating IPs to use if HA mode is set to 'FloatingIP'. If provided, should be of length 4 and contain 4 IP addresses outside of the VPC range. | `list(string)` | <pre>[<br>  null,<br>  null,<br>  null,<br>  null<br>]</pre> | no |
| <a name="input_connector_accountId"></a> [connector\_accountId](#input\_connector\_accountId) | AWS Account Id where NetApp connector is deployed, leave null if deployed int he same account as this module | `string` | `null` | no |
| <a name="input_connector_client_id"></a> [connector\_client\_id](#input\_connector\_client\_id) | The client ID of the Cloud Manager Connector. | `string` | n/a | yes |
| <a name="input_data_encryption_type"></a> [data\_encryption\_type](#input\_data\_encryption\_type) | (Optional) The type of encryption to use for the working environment: ['AWS', 'NONE']. The default is 'AWS'. | `string` | `"AWS"` | no |
| <a name="input_ebs_volume_size"></a> [ebs\_volume\_size](#input\_ebs\_volume\_size) | (Optional) EBS volume size for the first data aggregate. For GB, the unit can be: [100 or 500]. For TB, the unit can be: [1,2,4,8,16]. The default is '1' | `number` | `1` | no |
| <a name="input_ebs_volume_size_unit"></a> [ebs\_volume\_size\_unit](#input\_ebs\_volume\_size\_unit) | (Optional) ['GB' or 'TB']. The default is 'TB'. | `string` | `"TB"` | no |
| <a name="input_ebs_volume_type"></a> [ebs\_volume\_type](#input\_ebs\_volume\_type) | (Optional) The EBS volume type for the first data aggregate ['gp2','io1','st1','sc1']. The default is 'gp2'. | `string` | `"gp2"` | no |
| <a name="input_egress_cidr_blocks"></a> [egress\_cidr\_blocks](#input\_egress\_cidr\_blocks) | List of CIDR blocks to allow egress traffic from CVO nodes to. | `list(string)` | <pre>[<br>  "0.0.0.0/0"<br>]</pre> | no |
| <a name="input_failover_mode"></a> [failover\_mode](#input\_failover\_mode) | The failover mode for the HA pair: ['PrivateIP', 'FloatingIP']. 'PrivateIP' is for a single availability zone and 'FloatingIP' is for multiple availability zones. | `string` | `"FloatingIP"` | no |
| <a name="input_ingress_cidr_blocks"></a> [ingress\_cidr\_blocks](#input\_ingress\_cidr\_blocks) | List of CIDR blocks to allow ingress traffic to CVO nodes from. | `list(string)` | `[]` | no |
| <a name="input_ingress_security_group_ids"></a> [ingress\_security\_group\_ids](#input\_ingress\_security\_group\_ids) | List of security groups blocks to allow ingress traffic to CVO nodes from. | `list(string)` | `[]` | no |
| <a name="input_instance_type"></a> [instance\_type](#input\_instance\_type) | (Optional) The instance type to use, which depends on the license type: Explore:['m5.xlarge'], Standard:['m5.2xlarge','r5.xlarge'], Premium:['m5.4xlarge','r5.2xlarge','c4.8xlarge'], BYOL: all instance types defined for PayGo. For more supported instance types, refer to Cloud Volumes ONTAP Release Notes. The default is 'm5.2xlarge'. | `string` | `"m5.xlarge"` | no |
| <a name="input_io1_iops"></a> [io1\_iops](#input\_io1\_iops) | (Optional) Provisioned IOPS. Required only when providerVolumeType is 'io1'. | `number` | `null` | no |
| <a name="input_is_ha"></a> [is\_ha](#input\_is\_ha) | Enable HA mode for Netapp Cloudmanager CVO | `bool` | `true` | no |
| <a name="input_license_type"></a> [license\_type](#input\_license\_type) | The type of license to use. For single node: ['cot-explore-paygo','cot-standard-paygo', 'cot-premium-paygo', 'cot-premium-byol']. For HA: ['ha-cot-explore-paygo','ha-cot-standard-paygo','ha-cot-premium-paygo','ha-cot-premium-byol']. | `string` | `"ha-cot-explore-paygo"` | no |
| <a name="input_managed_tag_key"></a> [managed\_tag\_key](#input\_managed\_tag\_key) | Tag key to attach to all instances to indicate these are managed by Netapp Cloudmanager. Used to control termination permissions. | `string` | `"CloudManager-Managed"` | no |
| <a name="input_mediator_assign_public_ip"></a> [mediator\_assign\_public\_ip](#input\_mediator\_assign\_public\_ip) | Assign a public IP to the mediator. Default is false to route via existing egress path. | `bool` | `false` | no |
| <a name="input_mediator_key_pair_name"></a> [mediator\_key\_pair\_name](#input\_mediator\_key\_pair\_name) | The key pair name for the mediator instance. | `string` | `null` | no |
| <a name="input_name"></a> [name](#input\_name) | Name for the resources table being created | `string` | n/a | yes |
| <a name="input_nss_account"></a> [nss\_account](#input\_nss\_account) | (Optional) The NetApp Support Site account ID to use with this Cloud Volumes ONTAP system. If the license type is BYOL and an NSS account isn't provided, Cloud Manager tries to use the first existing NSS account. | `string` | `null` | no |
| <a name="input_ontap_version"></a> [ontap\_version](#input\_ontap\_version) | (Optional) The required ONTAP version. Ignored if 'use\_latest\_version' is set to true. The default is to use the latest version. | `string` | `null` | no |
| <a name="input_platform_serial_numbers"></a> [platform\_serial\_numbers](#input\_platform\_serial\_numbers) | For HA BYOL, the serial numbers for the two nodes. This can be left nulled if using paygo, and should contain a list of one or two entries for single node or HA deploys respectively. | `list(string)` | <pre>[<br>  null,<br>  null<br>]</pre> | no |
| <a name="input_route_table_ids"></a> [route\_table\_ids](#input\_route\_table\_ids) | The list of route table IDs that will be updated when using HA failover\_mode of FloatingIP. | `list(string)` | `null` | no |
| <a name="input_subnet_ids"></a> [subnet\_ids](#input\_subnet\_ids) | List of Subnet IDs to build CVO resources. | `list(string)` | n/a | yes |
| <a name="input_svm_password"></a> [svm\_password](#input\_svm\_password) | The admin password for Cloud Volumes ONTAP. | `string` | n/a | yes |
| <a name="input_tags"></a> [tags](#input\_tags) | List of tags to apply to all resources. | `map(string)` | `{}` | no |
| <a name="input_tier_level"></a> [tier\_level](#input\_tier\_level) | (Optional) The tiering level when 'capacity\_tier' is set to 'S3' ['normal','ia','ia-single','intelligent']. The default is 'normal'. | `string` | `"normal"` | no |
| <a name="input_use_latest_version"></a> [use\_latest\_version](#input\_use\_latest\_version) | (Optional) Indicates whether to use the latest available ONTAP version. The default is 'true'. | `bool` | `true` | no |
| <a name="input_vpc_id"></a> [vpc\_id](#input\_vpc\_id) | VPC ID to build CVO resources. | `string` | n/a | yes |
| <a name="input_workspace_id"></a> [workspace\_id](#input\_workspace\_id) | (Optional) The ID of the Cloud Manager workspace where you want to deploy Cloud Volumes ONTAP. If not provided, Cloud Manager uses the first workspace. | `string` | `null` | no |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_cvo_id"></a> [cvo\_id](#output\_cvo\_id) | ID of the Cloudmanager CVO environment |
| <a name="output_cvo_instance_profile_arn"></a> [cvo\_instance\_profile\_arn](#output\_cvo\_instance\_profile\_arn) | ARN of the instance profile created for CVO instances |
| <a name="output_cvo_instance_profile_name"></a> [cvo\_instance\_profile\_name](#output\_cvo\_instance\_profile\_name) | Name of the instance profile created for CVO instances |
| <a name="output_cvo_instance_profile_unique_id"></a> [cvo\_instance\_profile\_unique\_id](#output\_cvo\_instance\_profile\_unique\_id) | Unique identifier of the instance profile created for CVO instances |
| <a name="output_cvo_role_arn"></a> [cvo\_role\_arn](#output\_cvo\_role\_arn) | ARN of the role created for CVO instances |
| <a name="output_cvo_role_name"></a> [cvo\_role\_name](#output\_cvo\_role\_name) | Name of the role created for CVO instances |
| <a name="output_cvo_role_unique_id"></a> [cvo\_role\_unique\_id](#output\_cvo\_role\_unique\_id) | Unique identifier of the role created for CVO instances |
| <a name="output_cvo_security_group_id"></a> [cvo\_security\_group\_id](#output\_cvo\_security\_group\_id) | ID of the security group all CVO instances are a memeber of |
<!-- END OF PRE-COMMIT-TERRAFORM DOCS HOOK -->

## Development

### Prerequisites

- [terraform](https://learn.hashicorp.com/terraform/getting-started/install#installing-terraform)
- [terraform-docs](https://github.com/segmentio/terraform-docs)
- [pre-commit](https://pre-commit.com/#install)
- [golang](https://golang.org/doc/install#install)
- [golint](https://github.com/golang/lint#installation)

### Configurations

- Configure pre-commit hooks
```sh
pre-commit install
```


- Configure golang deps for tests
```sh
> go get github.com/gruntwork-io/terratest/modules/terraform
> go get github.com/stretchr/testify/assert
```



### Tests

- Tests are available in `test` directory

- In the test directory, run the below command
```sh
export "REFRESH_TOKEN='your_refresh_token'"
go test -v ./ -timeout 300m
```
Initializing the cluster can take 30 minutes, so we set a very high timeout to ensure that we always have time for cleanup tasks to run.


## Authors

This project is authored by below people

- Matt Stone

> This project was generated by [generator-tf-module](https://github.com/sudokar/generator-tf-module)
