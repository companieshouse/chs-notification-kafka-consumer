# multi_az_subnets

> This project was generated by [generator-tf-module](https://github.com/sudokar/generator-tf-module)

## Overview

A Terraform module that accepts a list of subnet names and new bit numbers and creates a sequential range of subnet CIDR addresses. These are then used to create the subnets as required using this CIDR list.

## Usage

```hcl
module "multi_az_subnets" {
  source = "git@github.com:companieshouse/terraform-modules//aws/multi_az_subnets"
  
  vpc_id = vpc-1234
  networks = [
    {
      name     = "foo"
      new_bits = 8
    },
    {
      name     = "bar"
      new_bits = 8
    }
  ]

  tags = {
    name = "subnet"
  }
}
```

The module assigns consecutive IP address blocks to each of the requested
networks, packing them densely in the address space. The `network_cidr_blocks`
output as follows:

```hcl
{
  sub-foo-a = {
    name = sub-foo-a
    cidr = "10.0.1.0/24"
    az = eu-west-2a
  }.
  sub-foo-b = {
    name = sub-foo-b
    cidr = "10.0.2.0/24"
    az = eu-west-2b
  },
  sub-foo-c = {
    name = sub-foo-c
    cidr = "10.0.3.0/24"
    az = eu-west-2c
  },
  sub-bar-a = {
    name = sub-bar-a
    cidr = "10.0.4.0/24"
    az = eu-west-2a
  }.
  sub-bar-b = {
    name = sub-bar-b
    cidr = "10.0.5.0/24"
    az = eu-west-2b
  },
  sub-bar-c = {
    name = sub-bar-c
    cidr = "10.0.5.0/24"
    az = eu-west-2c
  },
}
```

The `new_bits` values are the number of _additional_ address bits to use for
numbering the new networks. Because network `foo` has a `new_bits` of 8,
and the base CIDR block has an existing prefix of 8, its final prefix length
is 8 + 8 = 16. `baz` has a `new_bits` of 8, so its final prefix length is
only 8 + 4 = 12 bits.

### Changing Networks Later

When initially declaring your network addressing scheme, you can declare your
networks in any order. However, the positions of the networks in the request
list affects the assigned network numbers, so when making changes later it's
important to take care to avoid implicitly renumbering other networks.

The safest approach is to only add new networks to the end of the list and
to never remove an existing network or or change its `new_bits` value. If
an existing allocation becomes obsolute, you can set its name explicitly to
`null` to skip allocating it a prefix but to retain the space it previously
occupied in the address space:

```hcl
module "subnet_addrs" {
  source = "git@github.com:companieshouse/terraform-modules//aws/multi_az_subnets"

  vpc_id = vpc-1234
  networks = [
    {
      name     = null # formerly "foo", but no longer used
      new_bits = 8
    },
    {
      name     = "bar"
      new_bits = 8
    },
  ]

  tags = {
    name = "subnet"
  }
}
```

In the above example, the `network_cidr_blocks` output would have the
following value:

```
{
  bar = "10.1.0.0/16"
}
```

`foo` has been excluded, but its former prefix `10.0.0.0/16` is now skipped
altogether so `bar` retains its allocation of `10.1.0.0/16`.

Because the `networks` output is a list that preserves the element indices
of the requested networks, it _does_ still include the skipped networks, but
with their `name` and `cidr_blocks` attributes set to null:

```
[
  {
    name       = null
    new_bits   = 8
    cidr_block = null
  },
  {
    name       = "bar"
    new_bits   = 8
    cidr_block = "10.1.0.0/16"
  },
]
```

We don't recommend using the `networks` output when networks are skipped in
this way, but if you _do_ need to preserve the indices while excluding the
null items you could use a `for` expression to project the indices into
attributes of the objects:

```
[
  for i, n in module.subnet_addrs.networks : {
    index      = i
    name       = n.name
    cidr_block = n.cidr_block
  }
  if n.cidr_block != null
]
```

Certain edits to existing allocations are possible without affecting
subsequent allocations, as long as you are careful to ensure that the new
allocation occupies the same address space as whatever replaced it.

For example, it's safe to replace a single allocation anywhere in the
list with a pair of consecutive allocations whose `new_bits` value is one
greater. If you have an allocation with `new_bits` set to 4, you can replace
it with two allocations that have `new_bits` set to 5 as long as those two
new allocations retain their position in the overall list:

```hcl
  networks = [
    # "foo-1" and "foo-2" replace the former "foo", taking half of the
    # former address space each: 10.0.0.0/17 and 10.0.128.0/17, respectively.
    {
      name     = "foo-1"
      new_bits = 9
    },
    {
      name     = "foo-2"
      new_bits = 9
    },

    # "bar" is still at 10.1.0.0/16
    {
      name     = "bar"
      new_bits = 8
    },
  ]
```

When making in-place edits to existing networks, be sure to verify that the
result is as you expected using `terraform plan` before applying, to avoid
disruption to already-provisioned networks that you want to keep.

<!-- BEGINNING OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 1.3, < 2.0 |
| <a name="requirement_aws"></a> [aws](#requirement\_aws) | >= 5.0, < 6.0 |

## Providers

| Name | Version |
|------|---------|
| <a name="provider_aws"></a> [aws](#provider\_aws) | >= 5.0, < 6.0 |

## Modules

No modules.

## Resources

| Name | Type |
|------|------|
| [aws_subnet.main](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/subnet) | resource |
| [aws_availability_zones.zones](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/availability_zones) | data source |
| [aws_vpc.vpc](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/vpc) | data source |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_networks"></a> [networks](#input\_networks) | A list of objects describing requested subnetwork prefixes. new\_bits is the number of additional network prefix bits to add, in addition to the existing prefix on base\_cidr\_block. | <pre>list(object({<br>    name     = string<br>    new_bits = number<br>  }))</pre> | n/a | yes |
| <a name="input_tags"></a> [tags](#input\_tags) | A map of tags to add to all resources | `map(string)` | `{}` | no |
| <a name="input_vpc_id"></a> [vpc\_id](#input\_vpc\_id) | VPC Id for the VPC to create these subnets in | `string` | n/a | yes |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_named_subnet_ids"></a> [named\_subnet\_ids](#output\_named\_subnet\_ids) | Map of subnet names to subnet IDs |
| <a name="output_network_cidr_blocks"></a> [network\_cidr\_blocks](#output\_network\_cidr\_blocks) | A map from network names to allocated address prefixes in CIDR notation. |
| <a name="output_networks"></a> [networks](#output\_networks) | A list of objects corresponding to each of the objects in the local 'network\_objs', each extended with a new attribute 'subnet\_id' to make this global usable for subnet details |
| <a name="output_subnet_ids"></a> [subnet\_ids](#output\_subnet\_ids) | A list of subnet Ids created using this module |
<!-- END OF PRE-COMMIT-TERRAFORM DOCS HOOK -->

## Development

### Prerequisites

- [terraform](https://learn.hashicorp.com/terraform/getting-started/install#installing-terraform)
- [terraform-docs](https://github.com/segmentio/terraform-docs)
- [pre-commit](https://pre-commit.com/#install)
- [golang](https://golang.org/doc/install#install)
- [golint](https://github.com/golang/lint#installation)

### Configurations

- Configure pre-commit hooks
```sh
pre-commit install
```


- Configure golang deps for tests
```sh
> go get github.com/gruntwork-io/terratest/modules/terraform
> go get github.com/stretchr/testify/assert
```



### Tests

- Tests are available in `test` directory

- In the test directory, run the below command
```sh
go test
```



## Authors

This project is authored by below people

- Martin Fox

> This project was generated by [generator-tf-module](https://github.com/sudokar/generator-tf-module)
