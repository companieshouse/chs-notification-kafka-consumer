# squid_proxy

> This project was generated by [generator-tf-module](https://github.com/sudokar/generator-tf-module)

## Overview

Squid Proxy

## Usage

```hcl
module "squid_proxy" {
  source = "git::git@github.com:companieshouse/terraform-modules//aws/squid_proxy?ref=1.0.21"

  name                     = format("%s-%s", var.account, "squid")
  instance_type            = "t3.medium"
  ami_id                   = data.aws_ami.squid_ami.id
  key_name                 = var.key_pair_name
  proxy_http_ingress_cidrs = var.proxy_http_ingress_cidrs
  proxy_mgmt_ingress_cidrs = var.proxy_mgmt_ingress_cidrs
  vpc_id                   = local.egress_vpc_id
  private_subnet_ids       = local.private_subnets
  tags                     = local.default_tags
}
```

<!-- BEGINNING OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 0.13.0, < 0.14 |
| <a name="requirement_aws"></a> [aws](#requirement\_aws) | >= 0.3, < 4.0 |

## Providers

| Name | Version |
|------|---------|
| <a name="provider_archive"></a> [archive](#provider\_archive) | n/a |
| <a name="provider_aws"></a> [aws](#provider\_aws) | >= 0.3, < 4.0 |
| <a name="provider_template"></a> [template](#provider\_template) | n/a |

## Modules

No modules.

## Resources

| Name | Type |
|------|------|
| [aws_autoscaling_group.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/autoscaling_group) | resource |
| [aws_autoscaling_lifecycle_hook.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/autoscaling_lifecycle_hook) | resource |
| [aws_cloudwatch_log_group.lambda_logs](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_log_group) | resource |
| [aws_cloudwatch_metric_alarm.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_metric_alarm) | resource |
| [aws_iam_instance_profile.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_instance_profile) | resource |
| [aws_iam_policy.lambda](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_policy) | resource |
| [aws_iam_policy.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_policy) | resource |
| [aws_iam_role.lambda](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role) | resource |
| [aws_iam_role.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role) | resource |
| [aws_iam_role_policy_attachment.lambda](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role_policy_attachment) | resource |
| [aws_iam_role_policy_attachment.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role_policy_attachment) | resource |
| [aws_iam_role_policy_attachment.this_ssm](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role_policy_attachment) | resource |
| [aws_lambda_function.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lambda_function) | resource |
| [aws_lambda_permission.lambda](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lambda_permission) | resource |
| [aws_launch_template.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/launch_template) | resource |
| [aws_security_group.lambda](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group) | resource |
| [aws_security_group.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group) | resource |
| [aws_security_group_rule.app_egress](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group_rule) | resource |
| [aws_security_group_rule.lambda_egress](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group_rule) | resource |
| [aws_security_group_rule.proxy_http_ingress](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group_rule) | resource |
| [aws_security_group_rule.proxy_mgmt_ingress](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group_rule) | resource |
| [aws_sns_topic.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/sns_topic) | resource |
| [aws_sns_topic_subscription.lambda](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/sns_topic_subscription) | resource |
| [archive_file.lambda_code](https://registry.terraform.io/providers/hashicorp/archive/latest/docs/data-sources/file) | data source |
| [aws_caller_identity.current](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/caller_identity) | data source |
| [aws_iam_policy.ssm](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy) | data source |
| [aws_iam_policy_document.lambda](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document) | data source |
| [aws_iam_policy_document.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document) | data source |
| [aws_kms_key.ssm_logs_kms_key](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/kms_key) | data source |
| [aws_kms_key.ssm_session_kms_key](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/kms_key) | data source |
| [aws_region.current](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/region) | data source |
| [aws_subnet.private_subnets](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/subnet) | data source |
| [template_file.lambda_code](https://registry.terraform.io/providers/hashicorp/template/latest/docs/data-sources/file) | data source |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_ami_id"></a> [ami\_id](#input\_ami\_id) | AMI id for proxy instance autoscaling configuration | `string` | `null` | no |
| <a name="input_asg_health_check_grace_period"></a> [asg\_health\_check\_grace\_period](#input\_asg\_health\_check\_grace\_period) | Time (in seconds) after instance comes into service before checking health. | `number` | `300` | no |
| <a name="input_cloudwatch_logs_to_collect"></a> [cloudwatch\_logs\_to\_collect](#input\_cloudwatch\_logs\_to\_collect) | A list of log files to allow the instance to send logs to via the instance profile.When default Null used, the built in module log group will be used. | `any` | `null` | no |
| <a name="input_custom_iam_statements"></a> [custom\_iam\_statements](#input\_custom\_iam\_statements) | A list of statement blocks to create in addition to the built in permissions for squid e.g. additional S3 bucket access. | `any` | `null` | no |
| <a name="input_enable_ssm"></a> [enable\_ssm](#input\_enable\_ssm) | Boolean to toggle dependancies for SSM to be created, e.g. IAM permissions. Requires agent to be pre-configured on AMI. | `bool` | `true` | no |
| <a name="input_ingress_route_table_ids"></a> [ingress\_route\_table\_ids](#input\_ingress\_route\_table\_ids) | List of route table ID's (one per subnet) we will update to route via the correct proxy instance. Length should be equal to 'var.private\_subnet\_ids' and be in the same AZ order. | `list(string)` | n/a | yes |
| <a name="input_instance_type"></a> [instance\_type](#input\_instance\_type) | Instance type for proxy instance autoscaling configuration | `string` | `"t3.small"` | no |
| <a name="input_key_name"></a> [key\_name](#input\_key\_name) | Existing SSH key for management of proxy instances | `string` | `null` | no |
| <a name="input_lambda_timeout"></a> [lambda\_timeout](#input\_lambda\_timeout) | Time in seconds the lambda has to execute. | `number` | `30` | no |
| <a name="input_log_group_retention_in_days"></a> [log\_group\_retention\_in\_days](#input\_log\_group\_retention\_in\_days) | Time in days to retain logs for, defaults to 365 | `number` | `365` | no |
| <a name="input_name"></a> [name](#input\_name) | Identifier portion of the name, will have identifier prefix and suffix based on resource type and identifiers: e.g. asg-{var.name}-001 | `string` | n/a | yes |
| <a name="input_private_subnet_ids"></a> [private\_subnet\_ids](#input\_private\_subnet\_ids) | List of private subnets to create proxy instances in. All subnets must be in the VPC provided in var.vpc\_id and should be in separate availability zones. | `list(string)` | n/a | yes |
| <a name="input_proxy_http_ingress_cidrs"></a> [proxy\_http\_ingress\_cidrs](#input\_proxy\_http\_ingress\_cidrs) | List of CIDR ranges to allow ingress traffic to ports provided in var.proxy\_http\_ingress\_ports from | `list(string)` | `null` | no |
| <a name="input_proxy_http_ingress_ports"></a> [proxy\_http\_ingress\_ports](#input\_proxy\_http\_ingress\_ports) | List of ports to allow ingress traffic to for CIDR ranges provided in var.proxy\_http\_ingress\_cidrs | `list(number)` | <pre>[<br>  80,<br>  443<br>]</pre> | no |
| <a name="input_proxy_mgmt_ingress_cidrs"></a> [proxy\_mgmt\_ingress\_cidrs](#input\_proxy\_mgmt\_ingress\_cidrs) | List of CIDR ranges to allow ingress traffic to ports provided in var.proxy\_mgmt\_ingress\_ports from | `list(string)` | `null` | no |
| <a name="input_proxy_mgmt_ingress_ports"></a> [proxy\_mgmt\_ingress\_ports](#input\_proxy\_mgmt\_ingress\_ports) | List of ports to allow ingress traffic to for CIDR ranges provided in var.proxy\_mgmt\_ingress\_cidrs | `list(number)` | <pre>[<br>  22<br>]</pre> | no |
| <a name="input_sns_kms_key"></a> [sns\_kms\_key](#input\_sns\_kms\_key) | KMS key ID, ARN or Alias for encryption of the SNS queue. Default is AWS provided key, set to null to disable encryption | `string` | `"alias/aws/sns"` | no |
| <a name="input_ssm_logs_bucket"></a> [ssm\_logs\_bucket](#input\_ssm\_logs\_bucket) | AWS S3 bucket name for SSM logs, used to create IAM permissions. | `string` | `null` | no |
| <a name="input_ssm_logs_kms_key"></a> [ssm\_logs\_kms\_key](#input\_ssm\_logs\_kms\_key) | KMS key ID used for SSM logs encryption. | `string` | `null` | no |
| <a name="input_ssm_session_kms_key"></a> [ssm\_session\_kms\_key](#input\_ssm\_session\_kms\_key) | KMS key ID used for SSM session encryption. | `string` | `null` | no |
| <a name="input_tags"></a> [tags](#input\_tags) | Map of tags to apply to all taggable resources created by this module | `map(string)` | `{}` | no |
| <a name="input_userdata_template_custom"></a> [userdata\_template\_custom](#input\_userdata\_template\_custom) | A pre-templated userdata input (using templatefile) that can be supplied to the launch template for the squid EC2. When default Null used, the built in module userdata will be used. | `any` | `null` | no |
| <a name="input_vpc_id"></a> [vpc\_id](#input\_vpc\_id) | VPC ID to create proxy infrastructure in | `string` | `null` | no |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_autoscaling_group_arns"></a> [autoscaling\_group\_arns](#output\_autoscaling\_group\_arns) | n/a |
| <a name="output_autoscaling_group_names"></a> [autoscaling\_group\_names](#output\_autoscaling\_group\_names) | n/a |
| <a name="output_lambda_arn"></a> [lambda\_arn](#output\_lambda\_arn) | n/a |
| <a name="output_security_group"></a> [security\_group](#output\_security\_group) | n/a |
| <a name="output_sns_topic_arn"></a> [sns\_topic\_arn](#output\_sns\_topic\_arn) | n/a |
<!-- END OF PRE-COMMIT-TERRAFORM DOCS HOOK -->

## Development

### Prerequisites

- [terraform](https://learn.hashicorp.com/terraform/getting-started/install#installing-terraform)
- [terraform-docs](https://github.com/segmentio/terraform-docs)
- [pre-commit](https://pre-commit.com/#install)
- [golang](https://golang.org/doc/install#install)
- [golint](https://github.com/golang/lint#installation)

### Configurations

- Configure pre-commit hooks
```sh
pre-commit install
```


- Configure golang deps for tests
```sh
> go get github.com/gruntwork-io/terratest/modules/terraform
> go get github.com/stretchr/testify/assert
```



### Tests

- Tests are available in `test` directory

- In the test directory, run the below command
```sh
go test
```



## Authors

This project is authored by below people

- Matt Stone

> This project was generated by [generator-tf-module](https://github.com/sudokar/generator-tf-module)
